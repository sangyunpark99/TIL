### 병렬 처리 - Multi-threaded Step
청크 단위로 스레드를 할당하여, 각 스레드가 이 청크에 대해서 아이템들을 리드하고 프로세스하고 라이트까지 하는걸 말합니다.  
![img_17.png](img_17.png)

### 요구사항 1. 상품대량 등록(CSV -> DB)
성능 목표 : 10분 내에 상품 천만 개 등록
![img_18.png](img_18.png)

```java
package org.example.batch;

import io.prometheus.client.exporter.PushGateway;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

@SpringBootApplication
public class BatchApplication {

  public static void main(String[] args) {
    SpringApplication.run(BatchApplication.class, args);
  }

  @Bean
  public PushGateway pushGateway(
      @Value("${prometheus.pushgateway.url:localhost:9091}") String url) {
    return new PushGateway(url);
  }
}
```

스레드를 사용하기 위해 먼저 스레드를 가져올 수 있는 방법을 정의해야 합니다.  

Spring Batch에선 기본적으로 task Executor를 사용해서 스레드를 할당받습니다.  

```java
  @Bean
  public TaskExecutor taskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(128); // 최소 스레드 풀 크기
    executor.setMaxPoolSize(128);
    executor.setQueueCapacity(128); // 스레드 128개가 돌고 있는 상황에서 또 작업 요청이 오는 경우 사용
    executor.setAllowCoreThreadTimeOut(true); // 유휴 상태의 스레드를 종료할지 여부
    executor.setWaitForTasksToCompleteOnShutdown(true);
    executor.setAwaitTerminationSeconds(10);

    return executor;
  }
```
setCorePoolSize(128)
코어 스레드 풀 크기(기본 스레드 개수)를 128개로 설정합니다.  

setMaxPoolSize(128)
최대 스레드 개수를 128개로 설정  

setQueueCapacity(128)
작업 요청이 corePoolSize만큼 찼을 때 대기할 수 있는 작업 큐 크기  

setAllowCoreThreadTimeOut(true)
유휴 상태의 코어 스레드를 종료할지 여부  


setWaitForTasksToCompleteOnShutdown(true)
애플리케이션 종료 시, 실행 중인 작업이 끝날 때까지 기다릴지 여부  

```java
  @Bean
  public Step productUploadStep(JobRepository jobRepository,
      PlatformTransactionManager transactionManager,
      BatchStepExecutionListener batchStepExecutionListener,
      ItemReader<ProductUploadCsvRow> productReader,
      ItemProcessor<ProductUploadCsvRow, Product> productProcessor,
      ItemWriter<Product> productWriter
  ) {
    return new StepBuilder("productUploadStep", jobRepository)
        .<ProductUploadCsvRow, Product>chunk(1000, transactionManager)
        .reader(productReader)
        .processor(productProcessor)
        .writer(productWriter)
        .allowStartIfComplete(true) // 개발 단계에서는 true를 넣어서 돌립니다.
        .listener(batchStepExecutionListener)
        .taskExecutor(taskExecutor())
        .build();
  }
```
Step 부분에 taskExecutor를 주입 해줍니다.  
